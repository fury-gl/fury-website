

  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>A Stadia-like system for data visualization &mdash; FURY 0.7.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom_github.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> FURY
          

          
          </a>

          
            
            
              <div class="version">
                0.7.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">About Fury</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symlink/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../blog.html">Blog</a></li>
</ul>
<p class="caption"><span class="caption-text">Programming with Fury</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fury-pybullet.html">FURY - pyBullet Integration Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Developers Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symlink/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-history.html">Release History</a></li>
</ul>
<p class="caption"><span class="caption-text">Join our community!</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference external" href="https://discord.gg/6btFPPj">Discord Community</a></li>
<li class="toctree-l1"><a class="reference external" href="https://mail.python.org/mailman3/lists/fury.python.org">Mailing list</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/fury-gl/fury">Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/fury-gl/fury/issues/new/choose">File a bug</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/fury-gl/fury/issues/new/choose">Feature Request</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FURY</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>A Stadia-like system for data visualization</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/posts/2021/2021-06-12-gsoc-devmessias-2.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="a-stadia-like-system-for-data-visualization">
<h1>A Stadia-like system for data visualization<a class="headerlink" href="#a-stadia-like-system-for-data-visualization" title="Permalink to this headline">¶</a></h1>
<p>Hi all! In this post I’ll talk about the PR
<a class="reference external" href="https://github.com/fury-gl/fury/pull/437">#437</a>.</p>
<p>There are several reasons to have a streaming system for data
visualization. Because I’m doing a PhD in a developing country I always
need to think of the cheapest way to use the computational resources
available. For example, with the GPUs prices increasing, it’s necessary
to share a machine with a GPU with different users in different
locations. Therefore, to convince my Brazilian friends to use FURY I
need to code thinking inside of the (a) low-budget scenario.</p>
<p>To construct the streaming system for my project I’m thinking about the
following properties and behaviors:</p>
<ol class="arabic simple">
<li><p>I want to avoid blocking the code execution in the main thread (where
the vtk/fury instance resides).</p></li>
<li><p>The streaming should work inside of a low bandwidth environment.</p></li>
<li><p>I need an easy way to share the rendering result. For example, using
the free version of ngrok.</p></li>
</ol>
<p>To achieve the property <strong>1.</strong> we need to circumvent the GIL problem.
Using the threading module alone it’s not good enough because we can’t
use the python-threading for parallel CPU computation. In addition, to
achieve a better organization it’s better to define the server system as
an uncoupled module. Therefore, I believe that multiprocessing-lib in
python will fit very well for our proposes.</p>
<p>For the streaming system to work smoothly in a low-bandwidth scenario we
need to choose the protocol wisely. In the recent years the WebRTC
protocol has been used in a myriad of applications like google hangouts
and Google Stadia aiming low latency behavior. Therefore, I choose the
webrtc as my first protocol to be available in the streaming system
proposal.</p>
<p>To achieve the third property, we must be economical in adding
requirements and dependencies.</p>
<p>Currently, the system has some issues, but it’s already working. You can
see some tutorials about how to use this streaming system
<a class="reference external" href="https://github.com/devmessias/fury/tree/feature_fury_stream_client/docs/tutorials/04_stream">here</a>.
After running one of these examples you can easily share the results and
interact with other users. For example, using the ngrok For example,
using the ngrok</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">ngrok</span> <span class="n">http</span> <span class="mi">8000</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="how-does-it-works">
<h2>How does it works?<a class="headerlink" href="#how-does-it-works" title="Permalink to this headline">¶</a></h2>
<p>The image below it’s a simple representation of the streaming system.</p>
<p><img alt="image1" src="https://user-images.githubusercontent.com/6979335/121934889-33ff1480-cd1e-11eb-89a4-562fbb953ba4.png" /></p>
<p>As you can see, the streaming system is made up of different processes
that share some memory blocks with each other. One of the hardest part
of this PR was to code this sharing between different objects like VTK,
numpy and the webserver. I’ll discuss next some of technical issues that
I had to learn/circumvent.</p>
<div class="section" id="sharing-data-between-process">
<h3>Sharing data between process<a class="headerlink" href="#sharing-data-between-process" title="Permalink to this headline">¶</a></h3>
<p>We want to avoid any kind of unnecessary duplication of data or
expensive copy/write actions. We can achieve this economy of
computational resources using the multiprocessing module from python.</p>
<div class="section" id="multiprocessing-rawarray">
<h4>multiprocessing RawArray<a class="headerlink" href="#multiprocessing-rawarray" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">The
<a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.sharedctypes.RawArray">RawArray</a>
from multiprocessing allows to share resources between different
processes. However, there are some tricks to get a better performance
when we are dealing with RawArray’s. For example, <a class="reference external" href="https://github.com/devmessias/fury/tree/6ae82fd239dbde6a577f9cccaa001275dcb58229">take a look at my
PR in a older
stage.</a>
In this older stage my streaming system was working well. However, one
of my mentors (Filipi Nascimento) saw a huge latency for
high-resolutions examples. My first thought was that latency was
caused by the GPU-CPU copy from the opengl context. However, I
discovered that I’ve been using RawArray’s wrong in my entire life!</div>
<div class="line">See for example this line of code
<a class="reference external" href="https://github.com/devmessias/fury/blob/6ae82fd239dbde6a577f9cccaa001275dcb58229/fury/stream/client.py#L101">fury/stream/client.py#L101</a>
The code below shows how I’ve been updating the raw arrays</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">raw_arr_buffer</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_data</span>
</pre></div>
</div>
<p>This works fine for small and medium sized arrays, but for large ones it
takes a large amount of time, more than GPU-CPU copy. The explanation
for this bad performance is available here : <a class="reference external" href="https://stackoverflow.com/questions/33853543/demystifying-sharedctypes-performance">Demystifying sharedctypes
performance.</a>
The solution which gives a stupendous performance improvement is quite
simple. RawArrays implements the buffer protocol. Therefore, we just
need to use the memoryview:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">memview</span><span class="p">(</span><span class="n">arr_buffer</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">new_data</span>
</pre></div>
</div>
<p>The memview is really good, but there it’s a litle issue when we are
dealing with uint8 RawArrays. The following code will cause an exception:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">memview</span><span class="p">(</span><span class="n">arr_buffer_uint8</span><span class="p">)[:]</span> <span class="o">=</span> <span class="n">new_data_uint8</span>
</pre></div>
</div>
<p>There is a solution for uint8 rawarrays using just memview and cast
methods. However, numpy comes to rescue and offers a simple and a
generic solution. You just need to convert the rawarray to a np
representation in the following way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arr_uint8_repr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">as_array</span><span class="p">(</span><span class="n">arr_buffer_uint8</span><span class="p">)</span>
<span class="n">arr_uint8_repr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_data_uint8</span>
</pre></div>
</div>
<p>You can navigate to my repository in this specific <a class="reference external" href="https://github.com/devmessias/fury/commit/b1b0caf30db762cc018fc99dd4e77ba0390b2f9e">commit
position</a>
and test the streaming examples to see how this little modification
improves the performance.</p>
</div>
</div>
<div class="section" id="multiprocessing-inside-of-different-operating-systems">
<h3>Multiprocessing inside of different Operating Systems<a class="headerlink" href="#multiprocessing-inside-of-different-operating-systems" title="Permalink to this headline">¶</a></h3>
<p>Serge Koudoro, who is one of my mentors, has pointed out an issue of the
streaming system running in MacOs. I don’t know many things about MacOs,
and as pointed out by Filipi the way that MacOs deals with
multiprocessing is very different than the Linux approach. Although we
solved the issue discovered by Serge, I need to be more careful to
assume that different operating systems will behave in the same way. If
you want to know more,I recommend that you read this post <a class="reference external" href="https://britishgeologicalsurvey.github.io/science/python-forking-vs-spawn/">Python:
Forking vs
Spawm</a>.
And it’s also important to read the official documentation from python.
It can save you a lot of time. Take a look what the
official python documentation says about the multiprocessing method</p>
<p><img alt="image2" src="https://user-images.githubusercontent.com/6979335/121958121-b0ebb780-cd39-11eb-862a-37244f7f635b.png" /> Source:<a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html">https://docs.python.org/3/library/multiprocessing.html</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2021, FURY

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Documentation Versions</span>
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        
            
            <li><dd><a href="/dev/posts/2021/2021-06-12-gsoc-devmessias-2">fury dev</a></dd></li>
            
        
            
            <li><dd><a href="/latest/posts/2021/2021-06-12-gsoc-devmessias-2">fury latest</a></dd></li>
            
        
            
            <li><dd><a href="/v0.3.x/posts/2021/2021-06-12-gsoc-devmessias-2">fury v0.3.x</a></dd></li>
            
        
            
            <li><dd><a href="/v0.1.x/posts/2021/2021-06-12-gsoc-devmessias-2">fury v0.1.x</a></dd></li>
            
        
            
            <li><dt>fury v0.7.x</dt></li>
            
        
            
            <li><dd><a href="/v0.2.x/posts/2021/2021-06-12-gsoc-devmessias-2">fury v0.2.x</a></dd></li>
            
        
            
            <li><dd><a href="/v0.4.x/posts/2021/2021-06-12-gsoc-devmessias-2">fury v0.4.x</a></dd></li>
            
        
            
            <li><dd><a href="/v0.6.x/posts/2021/2021-06-12-gsoc-devmessias-2">fury v0.6.x</a></dd></li>
            
        
            
            <li><dd><a href="/v0.5.x/posts/2021/2021-06-12-gsoc-devmessias-2">fury v0.5.x</a></dd></li>
            
        
      </dl>
    </div>
  </div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    
    <link rel="stylesheet" href="../../_static/css/blog.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
        background: #990000;
    }
    /* Sidebar */
    .wy-nav-side {
        background: #4A3C31;
    }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@widgetbot/crate@3" async defer>
      new Crate({
        server: '695048505902891009',
        channel: '695305679682011217',
        shard: 'https://e.widgetbot.io',
        // glyph: ['https://i0.wp.com/www.puclpodcast.com/wp-content/uploads/2014/03/discord-chat-link-button.jpg?w=681&ssl=1', '100%'],
      })
    </script>
  

</body>
</html>